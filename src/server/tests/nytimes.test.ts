// Request URL: https://www.nytimes.com/
// Request Method: GET
// Status Code: 200 
// Remote Address: 151.101.65.164:443
// Referrer Policy: strict-origin-when-cross-origin
// accept-ranges: bytes
// age: 9
// cache-control: s-maxage=30,no-cache
// content-encoding: gzip
// content-length: 165328
// content-security-policy: upgrade-insecure-requests; default-src data: 'unsafe-inline' 'unsafe-eval' https:; script-src data: 'unsafe-inline' 'unsafe-eval' https: blob:; style-src data: 'unsafe-inline' https:; img-src data: https: blob: android-webview-video-poster:; font-src data: https:; connect-src https: wss: blob:; media-src data: https: blob:; object-src https:; child-src https: data: blob:; form-action https:; report-uri https://csp.nytimes.com/report;
// content-type: text/html; charset=utf-8
// date: Wed, 05 Apr 2023 19:09:31 GMT
// last-modified: Wed, 05 Apr 2023 19:09:20 GMT
// onion-location: https://www.nytimesn7cgmftshazwhfgzm37qxb44r64ytbb2dj3x62d2lljsciiyd.onion/
// server: nginx
// set-cookie: nyt-a=fyX2wMNyjamxu7oy5xaoVE; Expires=Thu, 04 Apr 2024 19:09:31 GMT; Path=/; Domain=.nytimes.com; SameSite=none; Secure
// set-cookie: nyt-gdpr=0; Expires=Thu, 06 Apr 2023 01:09:31 GMT; Path=/; Domain=.nytimes.com
// set-cookie: nyt-purr=cfshcfhshckfhd; Expires=Thu, 04 Apr 2024 19:09:31 GMT; Path=/; Domain=.nytimes.com; SameSite=Lax; Secure
// set-cookie: nyt-geo=US; Expires=Thu, 06 Apr 2023 01:09:31 GMT; Path=/; Domain=.nytimes.com
// set-cookie: nyt-b3-traceid=bcd1f97141a14a4b9a960916b10b11b2; Path=/; Domain=.nytimes.com; SameSite=none; Secure
// strict-transport-security: max-age=63072000; preload; includeSubdomains
// vary: Accept-Encoding, Fastly-SSL
// x-api-version: F-F-VI
// x-b3-traceid: 6e6819789dd84239b674b34e05a782bf
// x-cache: MISS, HIT
// x-cache-hits: 0, 1
// x-cloud-trace-context: 5a2a758b05b0207d8f65b6ad40142826/807710504055791513;o=1
// x-content-type-options: nosniff
// x-gdpr: 0
// x-nyt-app-webview: 0
// x-nyt-data-last-modified: Wed, 05 Apr 2023 19:09:20 GMT
// x-nyt-edge-cache: MISS-HIT
// x-nyt-route: homepage
// x-origin-time: 2023-04-05 19:09:22 UTC
// x-pagetype: vi-homepage
// x-served-by: cache-lga21971-LGA, cache-bos4620-BOS
// x-timer: S1680721771.134381,VS0,VE3
// x-xss-protection: 1; mode=block
//--
// :authority: www.nytimes.com
// :method: GET
// :path: /
// :scheme: https
// accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
// accept-encoding: gzip, deflate, br
// accept-language: en-US,en;q=0.9
// cache-control: no-cache
// cookie: nyt-a=fyX2wMNyjamxu7oy5xaoVE; _gcl_au=1.1.1751536896.1677074986; walley=GA1.2.505692258.1677074985; _cb=BrwquPD4VH9RlcRV-; nyt-gdpr=0; nyt-geo=US; _t_tests=eyJQYlVpaTI0bFZuck1YIjp7ImNob3NlblZhcmlhbnQiOiJBIiwic3BlY2lmaWNMb2NhdGlvbiI6WyJCYXVGSkciXX0sIjdrQkJPV25mN1A3QVQiOnsiY2hvc2VuVmFyaWFudCI6IkEiLCJzcGVjaWZpY0xvY2F0aW9uIjpbIkNqY2NZbCJdfSwibGlmdF9leHAiOiJtIn0=; edu_cig_opt=%7B%22isEduUser%22%3Afalse%7D; b2b_cig_opt=%7B%22isCorpUser%22%3Afalse%7D; _cb_svref=null; purr-cache=<K0<rUS-MA+US-VA<C_<G_<S0; SIDNY=CBMSLwjIjrehBhDAj7ehBhoSMS0pm9AdWfDLY5wH7eWemAwvIKKisD0qAh53OLzJgfUFGkBZ3xkrFle9lujosTUrxJdJ59Tykt34ZLaU6B_6n_wbE9zgCIQKQw4bhewih4qj0RYdNyT4Af1htrVE4WPdDRAA; NYT-MPS=0000000c6aeb9cc3ff92811ecf8db31ecbb434f999d6377779b6ecc114e28ccef5689916c651dde144b16da1b1ed75ae72a1db74188248e5c9f0a7dd8ab966; NYT-S=2ErvRSvcZu0DYtXDvGuF8PrHZP5U19mx47pdAJ0SrOSiD2fCIFeuFyj7/cBeEXhb4djOoea6bgYnTBH3pVcqmapu.UslWtWYyrB/jorEnSPcOCQIx6T8D1.i7RVNNu7RbqfYbz5c0l7drlVXYAVz0YtXDOc1G3keyrehT6JsWa6W3d4q1iYRFi/n1opczkJxThOgDWjJQNpihfspUBfD8bdnYg1xRK3ptP^^^^CBMSLwjIjrehBhDAj7ehBhoSMS0pm9AdWfDLY5wH7eWemAwvIKKisD0qAh53OLzJgfUFGkBZ3xkrFle9lujosTUrxJdJ59Tykt34ZLaU6B_6n_wbE9zgCIQKQw4bhewih4qj0RYdNyT4Af1htrVE4WPdDRAA; nyt-auth-method=sso; nyt-purr=cfshcfhshckfhd; RT="z=1&dm=nytimes.com&si=4e7a734d-8269-43e8-83ba-236eb02b77b6&ss=lg42blao&sl=1&tt=1c2&bcn=%2F%2F68794911.akstat.io%2F&ld=1hc&ul=6na&hd=6tg"; nyt-b3-traceid=2ec8947ed1c147729df24b0ed158a35f; nyt-jkidd=uid=128717090&lastRequest=1680721739935&activeDays=%5B0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C1%5D&adv=1&a7dv=1&a14dv=1&a21dv=1&lastKnownType=sub&newsStartDate=1678389713&entitlements=AAA+ATH+AUD+CKG+MM+MOW+MSD+MTD+WC+XWD; GoogleAdServingTest=Good; nyt-m=60550DD736D6372FD58CACDCD1A280C4&ira=i.0&s=s.core&prt=i.0&iue=i.1&ifv=i.0&igu=i.1&igd=i.0&e=i.1682949600&t=i.2&fv=i.0&cav=i.0&iga=i.0&er=i.1680721740&vr=l.4.0.0.0.0&iub=i.0&ird=i.0&pr=l.4.0.0.0.0&g=i.0&ft=i.0&iru=i.1&vp=i.0&imv=i.0&igf=i.0&iir=i.0&v=i.0&rc=i.0&imu=i.1&ier=i.0&uuid=s.279f3b17-7624-4769-b511-7cb1e6770fdf&n=i.2&ica=i.0; _chartbeat2=.1677074986460.1680721741588.0000000000000001.DICJmTNZDgpBOGk8rDZbwo6BxJKh5.2; iter_id=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhaWQiOiI2M2Y2MjAxM2E5MmI5OTAwMDE4ZTNlNWQiLCJhaWRfZXh0Ijp0cnVlLCJjb21wYW55X2lkIjoiNWMwOThiM2QxNjU0YzEwMDAxMmM2OGY5IiwiaWF0IjoxNjgwNzIxNzQyfQ.of258t4Txd8y2bMFSRjPDV8UnGJR4YZhyQTQYbv9dK8; datadome=6fS6ixR6b6pX8C3ALKP2nKbuwu17rXLDXssyOse2G2dbzpijFLW78F6_yVWAIGjxPvXqTVsFuvYU21X3NP7WpLoCsarTTuKWMCBNkdjfw3PVUV9spe-mtR7o0FaBokJg
// pragma: no-cache
// referer: https://www.nytimes.com/subscription/onboarding-offer?campaignId=7JFJX&EXIT_URI=https%3A%2F%2Fwww.nytimes.com%2F
// sec-ch-device-memory: 8
// sec-ch-ua: "Google Chrome";v="111", "Not(A:Brand";v="8", "Chromium";v="111"
// sec-ch-ua-arch: "x86"
// sec-ch-ua-full-version-list: "Google Chrome";v="111.0.5563.146", "Not(A:Brand";v="8.0.0.0", "Chromium";v="111.0.5563.146"
// sec-ch-ua-mobile: ?0
// sec-ch-ua-model: ""
// sec-ch-ua-platform: "macOS"
// sec-fetch-dest: document
// sec-fetch-mode: navigate
// sec-fetch-site: same-origin
// sec-fetch-user: ?1
// upgrade-insecure-requests: 1
// user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36

import axios from 'axios';
import { load } from 'cheerio';
import { JSDOM, VirtualConsole } from 'jsdom';
import 'dotenv/config';

import {
  describe,
  expect,
  jest,
  test,
} from '@jest/globals';

jest.setTimeout(30_000);

describe('fetch news from token gated outlet', () => {
  
  test('get from nytimes', async () => {
    try {
      const response = await axios.get('https://www.nytimes.com/article/trump-indictment-criminal-charges.html', {
      headers: {
        accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
        cookie: 'nyt-a=fyX2wMNyjamxu7oy5xaoVE; _gcl_au=1.1.1751536896.1677074986; walley=GA1.2.505692258.1677074985; _cb=BrwquPD4VH9RlcRV-; nyt-gdpr=0; nyt-geo=US; _t_tests=eyJQYlVpaTI0bFZuck1YIjp7ImNob3NlblZhcmlhbnQiOiJBIiwic3BlY2lmaWNMb2NhdGlvbiI6WyJCYXVGSkciXX0sIjdrQkJPV25mN1A3QVQiOnsiY2hvc2VuVmFyaWFudCI6IkEiLCJzcGVjaWZpY0xvY2F0aW9uIjpbIkNqY2NZbCJdfSwibGlmdF9leHAiOiJtIn0=; edu_cig_opt=%7B%22isEduUser%22%3Afalse%7D; b2b_cig_opt=%7B%22isCorpUser%22%3Afalse%7D; _cb_svref=null; purr-cache=<K0<rUS-MA+US-VA<C_<G_<S0; SIDNY=CBMSLwjIjrehBhDAj7ehBhoSMS0pm9AdWfDLY5wH7eWemAwvIKKisD0qAh53OLzJgfUFGkBZ3xkrFle9lujosTUrxJdJ59Tykt34ZLaU6B_6n_wbE9zgCIQKQw4bhewih4qj0RYdNyT4Af1htrVE4WPdDRAA; NYT-MPS=0000000c6aeb9cc3ff92811ecf8db31ecbb434f999d6377779b6ecc114e28ccef5689916c651dde144b16da1b1ed75ae72a1db74188248e5c9f0a7dd8ab966; NYT-S=2ErvRSvcZu0DYtXDvGuF8PrHZP5U19mx47pdAJ0SrOSiD2fCIFeuFyj7/cBeEXhb4djOoea6bgYnTBH3pVcqmapu.UslWtWYyrB/jorEnSPcOCQIx6T8D1.i7RVNNu7RbqfYbz5c0l7drlVXYAVz0YtXDOc1G3keyrehT6JsWa6W3d4q1iYRFi/n1opczkJxThOgDWjJQNpihfspUBfD8bdnYg1xRK3ptP^^^^CBMSLwjIjrehBhDAj7ehBhoSMS0pm9AdWfDLY5wH7eWemAwvIKKisD0qAh53OLzJgfUFGkBZ3xkrFle9lujosTUrxJdJ59Tykt34ZLaU6B_6n_wbE9zgCIQKQw4bhewih4qj0RYdNyT4Af1htrVE4WPdDRAA; nyt-auth-method=sso; nyt-purr=cfshcfhshckfhd; RT="z=1&dm=nytimes.com&si=4e7a734d-8269-43e8-83ba-236eb02b77b6&ss=lg42blao&sl=1&tt=1c2&bcn=%2F%2F68794911.akstat.io%2F&ld=1hc&ul=6na&hd=6tg"; nyt-b3-traceid=2ec8947ed1c147729df24b0ed158a35f; nyt-jkidd=uid=128717090&lastRequest=1680721739935&activeDays=%5B0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C0%2C1%5D&adv=1&a7dv=1&a14dv=1&a21dv=1&lastKnownType=sub&newsStartDate=1678389713&entitlements=AAA+ATH+AUD+CKG+MM+MOW+MSD+MTD+WC+XWD; GoogleAdServingTest=Good; nyt-m=60550DD736D6372FD58CACDCD1A280C4&ira=i.0&s=s.core&prt=i.0&iue=i.1&ifv=i.0&igu=i.1&igd=i.0&e=i.1682949600&t=i.2&fv=i.0&cav=i.0&iga=i.0&er=i.1680721740&vr=l.4.0.0.0.0&iub=i.0&ird=i.0&pr=l.4.0.0.0.0&g=i.0&ft=i.0&iru=i.1&vp=i.0&imv=i.0&igf=i.0&iir=i.0&v=i.0&rc=i.0&imu=i.1&ier=i.0&uuid=s.279f3b17-7624-4769-b511-7cb1e6770fdf&n=i.2&ica=i.0; _chartbeat2=.1677074986460.1680721741588.0000000000000001.DICJmTNZDgpBOGk8rDZbwo6BxJKh5.2; iter_id=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhaWQiOiI2M2Y2MjAxM2E5MmI5OTAwMDE4ZTNlNWQiLCJhaWRfZXh0Ijp0cnVlLCJjb21wYW55X2lkIjoiNWMwOThiM2QxNjU0YzEwMDAxMmM2OGY5IiwiaWF0IjoxNjgwNzIxNzQyfQ.of258t4Txd8y2bMFSRjPDV8UnGJR4YZhyQTQYbv9dK8; datadome=6fS6ixR6b6pX8C3ALKP2nKbuwu17rXLDXssyOse2G2dbzpijFLW78F6_yVWAIGjxPvXqTVsFuvYU21X3NP7WpLoCsarTTuKWMCBNkdjfw3PVUV9spe-mtR7o0FaBokJg',
        }
      });
      const virtualConsole = new VirtualConsole();
      virtualConsole.sendTo(console);
      const dom = new JSDOM(response.data, {
        pretendToBeVisual: true,
        runScripts: "dangerously",
        virtualConsole,
      });
      async function allowLoad() {
        return new Promise<string>((resolve, reject) => {
          setTimeout(() => {
            console.log(dom.window.document);
            console.log(dom.window.document.body);
            console.log(dom.window.document.body.querySelector('p')?.innerHTML);
            const $ = load(dom.window.document.body.textContent);
            resolve($('p,blockquote').text())
          }, 1_000);
        });
      }
      const r = await allowLoad()
      expect(r).toBeDefined();
    } catch(e) {
      console.log(e);
    }
  });
  
});
    